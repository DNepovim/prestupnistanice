---
import { Image } from "astro:assets";
import { client } from "../../tina/__generated__/client.ts";
import Layout from "../layouts/Layout.astro";
import {
  uppercaseFirstLetter,
  uppercaseEveryFirstLetters,
} from "../utils/uppercaseFirstLetter";

const req = Astro.request;
const url = new URL(req.url);
const segments = url.pathname.split("/").filter(Boolean);

function isDefined<T>(value: T | undefined | null): value is T {
  return value !== undefined && value !== null;
}

const recentBooks = (
  (await client.queries.booksConnection({ sort: "date", last: 9 })).data
    .booksConnection.edges ?? []
)
  .map((item) => item?.node)
  .filter(isDefined);
---

<Layout>
  <h1 class="pt-20 mb-40 font-alt text-4xl text-gray-600">
    {
      segments.length === 2 && segments[0] === "knihy" ? (
        <>
          Knihu{" "}
          <span class="block my-4 font-head text-7xl text-orange-900">
            {uppercaseFirstLetter(segments[1].replace(/-/g, " "))}
          </span>{" "}
          jsme zatím nevydali.
        </>
      ) : segments.length === 2 && segments[0] === "autori" ? (
        <>
          Od autora{" "}
          <span class="block my-4 font-head text-7xl text-orange-900">
            {uppercaseEveryFirstLetters(segments[1].replace(/-/g, " "))}
          </span>{" "}
          jsme zatím nic nevydali
        </>
      ) : (
        "Tuto knihu jsme ještě nevydali"
      )
    }
  </h1>
  <p class="font-alt text-xl">Ale vydali jsme řadu jiných knih:</p>
  <section class="grid grid-cols-3 gap-4">
    {
      recentBooks.map((book) => (
        <article class="flex flex-col gap-4 justify-end">
          {book.cover && (
            <Image
              alt={book.title}
              src={book.cover as string}
              width={157.5}
              height={225}
              class="shadow-2xl border border-gray-200"
            />
          )}

          <div>
            <h2
              class="font-head text-2xl"
              style={{ color: book.color ?? "black" }}
            >
              <a href={`/knihy/${book._sys.filename}`}>{book.title}</a>
            </h2>
            <p>
              {book.authors
                ?.filter((a) => a?.role === "author")
                .map((a, index) => (
                  <span class="whitespace-nowrap">
                    {index !== 0 ? ", " : ""}
                    <a
                      class="group text-gray-500 hover:text-black transition-colors font-alt"
                      href={`/autori/${a?.author?._sys.filename}`}
                    >
                      {a?.author?.firstname} {a?.author?.surname}
                    </a>
                  </span>
                ))}
            </p>
          </div>
        </article>
      ))
    }
  </section>
</Layout>
