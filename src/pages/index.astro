---
import { routes } from "../routes";
import { client } from "../../tina/__generated__/client.ts";
import Layout from "../layouts/Layout.astro";
import Section from "../components/Section.astro";
import Excerpt from "../components/Excerpt.astro";
import BooksGrid from "../components/BooksGrid.astro";
import ArrowLink from "../components/ArrowLink.astro";
import Book from "../components/Book.astro";
import { isDefined } from "../utils/isDefined";

const recentBooks = (
  (await client.queries.booksConnection({ sort: "date", last: 3 })).data
    .booksConnection.edges ?? []
)
  .map((item) => item?.node)
  .filter(isDefined);

const forKidsBooks = (
  (
    await client.queries.booksConnection({
      sort: "date",
      last: 3,
      filter: { category: { eq: "forKids" } },
    })
  ).data.booksConnection.edges ?? []
)
  .map((item) => item?.node)
  .filter(isDefined);

const philosophyBooks = (
  (
    await client.queries.booksConnection({
      sort: "date",
      last: 3,
      filter: { category: { eq: "philosophy" } },
    })
  ).data.booksConnection.edges ?? []
)
  .map((item) => item?.node)
  .filter(isDefined);
---

<Layout isHome>
  <sectino>
    <p
      class="text-2xl font-alt mt-16 text-center mb-24 italic px-6 text-gray-800"
    >
      Roddinné knižní nakladatelství, které se ve své ediční činnosti soustředí
      na kvalitní nekomerční tituly.
    </p>
  </sectino>
  <Section title="Nejnovější knihy">
    <div class="flex flex-col gap-16">
      {
        recentBooks.map((book, index) => (
          <Excerpt
            className={index % 2 === 0 ? "min-sm:pr-8" : "min-sm:pl-8"}
            title={book.title}
            description={book.description}
            image={book.cover ?? undefined}
            color={book.color ?? undefined}
            link={routes.books.detail(book)}
          >
            {book.authors
              ?.filter((a) => a?.role === "author")
              .map((a) => a?.author)
              .filter(isDefined)
              .map((a, index) => (
                <span class="whitespace-nowrap">
                  {index !== 0 ? ", " : ""}
                  <a
                    class="group text-gray-500 hover:text-black transition-colors font-alt"
                    href={routes.authors.detail(a)}
                  >
                    {a.firstname} {a.surname}
                  </a>
                </span>
              ))}
          </Excerpt>
        ))
      }
    </div>
    <div class="flex justify-center my-20">
      <ArrowLink href={routes.books.list()}>všechny knihy</ArrowLink>
    </div>
  </Section>
  {
    forKidsBooks.length > 0 && (
      <Section title="Knihy pro děti">
        <BooksGrid>
          {forKidsBooks.map((book) => (
            <Book
              title={book.title}
              link={routes.books.detail(book)}
              image={book.cover ?? undefined}
              color={book.color ?? undefined}
              authors={(book.authors ?? [])
                .filter((a) => a?.role === "author")
                .map((author) => author?.author)
                .filter(isDefined)
                .map((a) => ({ ...a, link: routes.authors.detail(a) }))}
            />
          ))}
        </BooksGrid>
      </Section>
    )
  }
  {
    philosophyBooks.length > 0 && (
      <Section title="Knihy pro filosofy">
        <BooksGrid>
          {philosophyBooks.map((book) => (
            <Book
              title={book.title}
              link={`/knihy/${book._sys.filename}`}
              image={book.cover ?? undefined}
              color={book.color ?? undefined}
              authors={(book.authors ?? [])
                .filter((a) => a?.role === "author")
                .map((author) => author?.author)
                .filter(isDefined)
                .map((a) => ({ ...a, link: routes.authors.detail(a) }))}
            />
          ))}
        </BooksGrid>
      </Section>
    )
  }
</Layout>
